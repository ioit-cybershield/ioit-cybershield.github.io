name: Preview â€“ Astro site

on:
  # Branches that should get previews
  push:
    branches:
      - dev
      - staging
      - feature/*
      - revamp
  # Optional: previews for PRs into main/dev
  pull_request:
    branches:
      - main
      - dev

permissions:
  contents: write # needed for comments in this repo
  pull-requests: write # to comment preview URLs on PRs

concurrency:
  group: preview-pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Astro site
        run: npm run build

      - name: Publish branch/PR preview
        uses: rajyan/preview-pages@v1
        with:
          # Use PAT stored as a secret
          token: ${{ secrets.PREVIEWS_TOKEN }}

          # Astro builds to `dist` by default
          source-dir: dist

          # Push static files into your preview repo
          target-repository: ioit-cybershield/cybershield-previews

          # All previews are kept under this folder in that repo
          target-dir: previews

          # Stable URL per branch / per PR instead of per-commit
          branch-per-commit: false
          pr-per-commit: false

          # Optional: have the action comment preview URLs on PRs
          pr-comment: each
          branch-comment: each
